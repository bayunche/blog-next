const fs = require(\'fs\')\nconst path = require(\'path\')\n\nconst UPLOAD_DIR = path.join(__dirname, \'..\/..\/public\/uploads\')\n\n// 确保上传目录存在\nif (!fs.existsSync(UPLOAD_DIR)) {\n  fs.mkdirSync(UPLOAD_DIR, { recursive: true })\n}\n\n/**\n * 上传图片到本地服务器\n * POST /api/upload/image\n */\nexports.uploadImage = async (ctx) => {\n  try {\n    const { file } = ctx.request.files || {}\n\n    if (!file) {\n      ctx.status = 400\n      ctx.body = { code: 400, message: \'请提供图片文件\' }\n      return\n    }\n\n    const reader = fs.createReadStream(file.filepath)\n    const fileName = `${Date.now()}_${file.originalFilename}`\n    const filePath = path.join(UPLOAD_DIR, fileName)\n    const writer = fs.createWriteStream(filePath)\n\n    await new Promise((resolve, reject) => {\n      writer.on(\'finish\', resolve)\n      writer.on(\'error\', reject)\n      reader.pipe(writer)\n    })\n\n    const fileUrl = `/uploads/${fileName}`\n\n    ctx.status = 200\n    ctx.body = {\n      code: 200,\n      message: \'上传成功\',\n      data: {\n        url: fileUrl,\n        displayUrl: fileUrl,\n      },\n    }\n  } catch (error) {\n    console.error(\'上传图片失败:\', error)\n    ctx.status = 500\n    ctx.body = { code: 500, message: error.message || \'上传失败\' }\n  }\n}\n\n/**\n * 批量上传图片\n * POST /api/upload/images\n */\nexports.uploadImages = async (ctx) => {\n  try {\n    const { files } = ctx.request.files || {}\n\n    if (!files || files.length === 0) {\n      ctx.status = 400\n      ctx.body = { code: 400, message: \'请提供图片文件\' }\n      return\n    }\n\n    const results = await Promise.all(\n      files.map(async (file) => {\n        const reader = fs.createReadStream(file.filepath)\n        const fileName = `${Date.now()}_${file.originalFilename}`\n        const filePath = path.join(UPLOAD_DIR, fileName)\n        const writer = fs.createWriteStream(filePath)\n\n        await new Promise((resolve, reject) => {\n          writer.on(\'finish\', resolve)\n          writer.on(\'error\', reject)\n          reader.pipe(writer)\n        })\n\n        const fileUrl = `/uploads/${fileName}`\n        return { url: fileUrl, displayUrl: fileUrl }\n      })\n    )\n\n    ctx.status = 200\n    ctx.body = {\n      code: 200,\n      message: \'批量上传成功\',\n      data: results,\n    }\n  } catch (error) {\n    console.error(\'批量上传图片失败:\', error)\n    ctx.status = 500\n    ctx.body = { code: 500, message: error.message || \'批量上传失败\' }\n  }\n}\n
