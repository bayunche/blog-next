services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    image: blog-next-web
    container_name: blog-next-web
    depends_on:
      - server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/certs:/etc/nginx/certs:ro
    restart: unless-stopped
    networks:
      - blog-network

  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    image: blog-next-server
    container_name: blog-next-server
    environment:
      NODE_ENV: production
      SERVER_PORT: "6060"
      MYSQL_HOST: mysql
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-react_blog}"
      MYSQL_USER: "${MYSQL_USER:-react_blog}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-change_me}"
      TOKEN_SECRET: "${TOKEN_SECRET:-your_secret_token_here}"
      TOKEN_EXPIRES_IN: "${TOKEN_EXPIRES_IN:-720h}"
      EMAIL_NOTICE_ENABLE: "${EMAIL_NOTICE_ENABLE:-false}"
      EMAIL_NOTICE_HOST: "${EMAIL_NOTICE_HOST:-smtp.qq.com}"
      EMAIL_NOTICE_PORT: "${EMAIL_NOTICE_PORT:-465}"
      EMAIL_NOTICE_SECURE: "${EMAIL_NOTICE_SECURE:-true}"
      EMAIL_NOTICE_USER: "${EMAIL_NOTICE_USER:-your_email@example.com}"
      EMAIL_NOTICE_PASS: "${EMAIL_NOTICE_PASS:-your_email_password}"
      EMAIL_NOTICE_SUBJECT: "${EMAIL_NOTICE_SUBJECT:-博客站 - 收到新的评论回复}"
      EMAIL_NOTICE_TEXT: "${EMAIL_NOTICE_TEXT:-您在博客站收到了新的回复}"
      EMAIL_NOTICE_WEB_HOST: "${EMAIL_NOTICE_WEB_HOST:-http://localhost}"
      GITHUB_CLIENT_ID: "${GITHUB_CLIENT_ID:-your_github_client_id}"
      GITHUB_CLIENT_SECRET: "${GITHUB_CLIENT_SECRET:-your_github_client_secret}"
      GITHUB_CALLBACK_URL: "${GITHUB_CALLBACK_URL:-http://localhost/api/auth/github/callback}"
      ADMIN_GITHUB_LOGIN_NAME: "${ADMIN_GITHUB_LOGIN_NAME:-your_github_username}"
    expose:
      - "6060"
    depends_on:
      mysql:
        condition: service_healthy
    volumes:
      - ./docker/backups:/app/backups
    restart: unless-stopped
    networks:
      - blog-network

  mysql:
    build:
      context: ./docker/mysql
      dockerfile: Dockerfile
    image: blog-next-mysql
    container_name: blog-next-mysql
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD:-root_password}"
      MYSQL_DATABASE: "${MYSQL_DATABASE:-react_blog}"
      MYSQL_USER: "${MYSQL_USER:-react_blog}"
      MYSQL_PASSWORD: "${MYSQL_PASSWORD:-change_me}"
      TZ: "Asia/Shanghai"
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
      - ./docker/backups:/backups
      - ./docker/mysql/scripts:/scripts
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - blog-network

volumes:
  mysql_data:
    driver: local

networks:
  blog-network:
    driver: bridge
